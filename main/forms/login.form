<?xml version="1.0" encoding="utf-8"?>
<?data-format version="0.400"?>
<Form>
  <Name value="login" />
  <Caption value="Login" />
  <Content>
    <Panel>
      <Name value="pnlMain" />
      <Orientation value="Vertical" />
      <Panel.Height value="#" />
      <Panel.Width value="*" />
      <CssClass>
        <CssClassConditional>
          <ClassName value="{theme}-panel" />
          <IsThemedStyle value="True" />
        </CssClassConditional>
      </CssClass>
    </Panel>
  </Content>
  <DataContext>
    <DataContext />
  </DataContext>
  <OnActivate>
    <ActionEvent ReferencedAction="~handler_login_OnActivate" />
  </OnActivate>
  <Actions>
    <ActionBlock>
      <Name value="handler_login_OnActivate" />
      <IsPrivate value="True" />
      <ActionLangBody IsValid="True">
        <Script><![CDATA[var appInfo = globals.appInfo
var user = globals.user 


actions.sendRequestGet("login", "loginResponse", true)
var sr = globals.sendResult

if sr.Valid then
	user.fromJson(sr.Message)
	
	var isAuthorized = form.actions.setUser()	
	appInfo.pageTitle = appInfo.appTitle + " - " + user.DisplayName
	
	if isAuthorized then
		navigation.main.lists.go()
	else
		var err = packages.main.globals.forms.error.params
		err.Caption = "Unauthorized access"
		err.Message = "Uživatel "+ user.fullName + " s loginem '" + user.userName + "' nemá příslušná oprávnění pro spuštení aplikace."
		system.consoleError(err.Message)
		navigation.main.error.goAndBack()
	endif
endif

/* OLD CODE

// Login + uživatelské role
globals.IsBusy = true
var response = apiobjects.cic.getAsync("loginRequestASEO")
globals.IsBusy = false

var err = packages.main.globals.forms.error.params
var type = response.getMessageType()

err.Caption = "Error sending loginRequestASEO"

if type in ["loginResponseASEO"] then
	var responseData = response.getJsonString()
	
	user.LoginResult.fromJson(responseData)
	if user.LoginResult.user.selectFirst().UserName.hasValue() then
		//Zpráva vrátí obsah o uživateli
		//Načte prostředí, ověřeného uživatele a role a vyhodnotí autorizaci 
		var isAuthorized = form.actions.setUser()
		appInfo.pageTitle = appInfo.appTitle + " - " + user.DisplayName
		
		if isAuthorized then
			navigation.main.lists.go()
		else
			err.Caption = "Unauthorized access"
			err.Message = "Uživatel "+ user.fullName + " s loginem '" + user.userName + "' nemá příslušná oprávnění pro spuštení aplikace."
			system.consoleError(err.Message)
			navigation.main.error.goAndBack()
		endif		
	endif
else if response.getMessageType() in ["IN906A"] then
	err.MsgType = type
	err.Msg = response.getJsonString()
	system.consoleError(err.MsgType)
	system.consoleError(err.Msg)
	navigation.main.error.goAndBack()
else if response.isError() then
	err.Message = response.getErrorMessage()
	system.consoleError(err.Message)
	navigation.main.error.goAndBack()
else
	err.Message = "Unexpected response message type: " + type
	system.consoleError(err.Message)
	navigation.main.error.goAndBack()
endif endif endif

*/]]></Script>
      </ActionLangBody>
      <DataContext>
        <ActionDataContext />
      </DataContext>
    </ActionBlock>
    <ActionBlock>
      <Name value="setUser" />
      <Description value="vraci true pokud ma uzivatel alespon jednu pristupovou roli CD" />
      <ActionLangBody IsValid="True">
        <Script><![CDATA[var user = globals.user
var ui = user.UserIdentity

user.userName = ui.UserName
user.fullName = ui.User

if ui.Email.count() > 0 then
	user.Mail = ui.Email.selectFirst().Value
endif

user.CuCode = ui.Company

// capitalize all roles to fix issue with different capitalization on solitea test and cs test
foreach r in ui.UserRole do
	r.Name = toUpper(r.Name)
endfor

if ui.UserRole.exists(current.Name = "EOS_ASEOAPPADMIN") then
	// only in isAppAdmin computed attribute, so it can't be changed
endif

if ui.UserRole.exists(current.Name = "EOS_ASEOREAD") then
	user.hasRoleRead = true
endif

if ui.UserRole.exists(current.Name = "EOS_ASEOWRITE") then
	user.hasRoleWrite = true
endif

if ui.UserRole.exists(current.Name = "EOS_ASEOAUTHORIZATIONREACTIVATION") then
	user.hasRoleAuthrorizationReactivation = true
endif

if ui.UserRole.exists(current.Name = "EOS_ASEOREADFILE") then
	user.hasRoleReadFile = true
endif

if ui.UserRole.exists(current.Name = "EOS_ASEOAUDIT") then
	user.hasRoleAudit = true
endif

if ui.UserRole.exists(current.Name = "EOS_ASEOHELPDESK") then
	user.hasRoleHelpdesk = true
endif

if ui.UserRole.exists(current.Name = "CDKLIENT_READ") then
	user.hasRoleRead = true
endif

if ui.UserRole.exists(current.Name = "CDKLIENT_WRITE") then
	user.hasRoleWrite = true
endif

if ui.UserRole.exists(current.Name = "CDKLIENT_ADMIN") then
	user.hasRoleAdmin = true
endif

// Vyhodnocení autorizace
if isTrue(user.hasRoleRead) or 
   isTrue(user.hasRoleWrite) or 
   isTrue(user.hasRoleHelpdesk) or 
   isTrue(user.hasRoleAdmin) then 
	result = true
endif

/* OLD CODE

var lru = user.LoginResult.user.selectFirst()

// Načteme Ověřeného Uživatele
user.userName = lru.userName
user.fullName = lru.fullName
user.Mail = lru.Mail

if lru.organisation.hasValue() then
	var org = lru.organisation.selectFirst() 
	var cu = org.code.selectFirst()
	
	user.CuCode = cu.code
	
	// Načteme role ověřeného uživatele	
	if lru.organisation.selectFirst().applRole.hasValue() then
		user.hasRoleRead = org.applRole.exists(current.applRoleCode = "CDklient_read")
		user.hasRoleWrite = org.applRole.exists(current.applRoleCode = "CDklient_write")
		user.hasRoleAdmin = org.applRole.exists(current.applRoleCode = "CDklient_admin")
	endif	
endif

// Vyhodnocení autorizace - stačí libovolná role pro přístup
if user.hasRoleRead or user.hasRoleWrite or user.hasRoleAdmin then 
	result = true
endif

*/]]></Script>
      </ActionLangBody>
      <DataContext>
        <ActionDataContext>
          <Children>
            <Attribute>
              <Name value="result" />
              <Caption value="Result" />
              <DataContextParameter.IsResult value="True" />
              <DeclaredType>
                <AttributeType>
                  <BaseType value="Bool" />
                </AttributeType>
              </DeclaredType>
            </Attribute>
          </Children>
        </ActionDataContext>
      </DataContext>
    </ActionBlock>
  </Actions>
</Form>